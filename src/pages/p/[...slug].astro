---
import { type CollectionEntry, getCollection } from 'astro:content';
import BlogLayout from '../../layouts/BlogLayout.astro';
import { render } from 'astro:content';
import { generateKeywords, generateImageAlt } from '../../utils/seo';
import { getTranslationData } from '../../utils/translationUtils';
import { calculateReadingTimeFromMarkdown } from '../../utils/readingTime';
import { AUTHOR } from '../../consts';
import { categories } from '../../data/categories';

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post, allPosts: posts },
  }));
}
interface Props {
  post: CollectionEntry<'blog'>;
  allPosts: CollectionEntry<'blog'>[];
}

const { post, allPosts } = Astro.props;
const { Content } = await render(post);

// Calculate reading time from post content
const readingTime = calculateReadingTimeFromMarkdown(post.body || '');

// Auto-generate keywords from tags and categories
const keywords = generateKeywords(post.data.tags || [], post.data.category || []);

// Auto-generate image alt text
const imageAlt = generateImageAlt(post.data.title);

// Use author from post data or fall back to default author from consts
const author = post.data.author || AUTHOR.name;

// Get category name from category ID
const categoryName =
  post.data.category && post.data.category.length > 0
    ? categories.find((cat) => cat.id === post.data.category![0])?.name || post.data.category![0]
    : null;

// Generate table of contents from markdown headings (post.body is raw markdown, not HTML)
const headingRegex = /^(#{2,3})\s+(.+)$/gm;
const tableOfContents = [...(post.body?.matchAll(headingRegex) ?? [])].map(([, hashes, text]) => {
  const level = hashes.length;
  const trimmedText = (text || '').trim();
  const slug = trimmedText.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  return { text: trimmedText, slug, level };
});

// Get translation data
const translationData = await getTranslationData(post, allPosts);
---

<BlogLayout
  title={post.data.title}
  description={post.data.description}
  pubDate={post.data.pubDate}
  updatedDate={post.data.updatedDate}
  heroImage={post.data.heroImage}
  minutesRead={readingTime}
  tags={post.data.tags}
  category={post.data.category}
  categoryName={categoryName}
  path={`/p/${post.id}`}
  imageAlt={imageAlt}
  author={author}
  keywords={keywords}
  tableOfContents={tableOfContents}
  showComments={post.data.showComments}
  translationData={translationData}
  currentPost={post}
  allPosts={allPosts}
>
  <Content />
</BlogLayout>
