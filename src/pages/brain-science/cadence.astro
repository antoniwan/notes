---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BrainScienceLayout from '../../components/brain-science/BrainScienceLayout.astro';
import MetricCard from '../../components/brain-science/MetricCard.astro';
import TimeSeriesChart from '../../components/brain-science/TimeSeriesChart.astro';
import BarChart from '../../components/brain-science/BarChart.astro';
import {
  getBrainSciencePosts,
  calculateBaseMetrics,
  calculateMonthlyPosts,
  calculateWeeklyPosts,
  calculateDayOfWeekStats,
  calculateMonthOfYearStats,
  calculateStreakMetrics,
} from '../../utils/brainScience/data';
import {
  generateDynamicInsights,
  calculateObjectiveMetrics,
  scoreToLetterGrade,
  letterGradeToColor,
} from '../../utils/insightGenerator';
import { format, differenceInDays } from 'date-fns';
import { BRAIN_SCIENCE_PAGES } from '../../data/brainScience';

// Get all published posts
const posts = await getBrainSciencePosts();

// Calculate base metrics using shared utilities
const baseMetrics = calculateBaseMetrics(posts);
const firstPostDate = baseMetrics.firstPostDate;
const lastPostDate = baseMetrics.lastPostDate;

// Use shared utilities for calculations
const monthlyPosts = calculateMonthlyPosts(posts, firstPostDate, lastPostDate);
const dayOfWeekStats = calculateDayOfWeekStats(posts);
const monthOfYearStats = calculateMonthOfYearStats(posts);
const streakMetrics = calculateStreakMetrics(posts);

// Extract streak data
const sortedStreaks = streakMetrics.streaks;
const sortedDrySpells = streakMetrics.drySpells;
const currentStreak = streakMetrics.currentStreak;
const longestStreak = streakMetrics.longestStreak;

// Productivity periods (months with most posts)
const productiveMonths = monthlyPosts
  .filter((month) => month.count > 0)
  .sort((a, b) => b.count - a.count)
  .slice(0, 5);

// Recent activity (last 30 days)
const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
const recentPosts = posts.filter((post) => post.data.pubDate >= thirtyDaysAgo);

// Calculate productivity metrics
const avgPostsPerMonth = Math.round(
  posts.length /
    Math.max(1, differenceInDays(lastPostDate || new Date(), firstPostDate || new Date()) / 30),
);
const consistencyScore =
  sortedStreaks.length / Math.max(1, sortedStreaks.length + sortedDrySpells.length);
const productivityTrend: 'improving' | 'declining' | 'stable' =
  recentPosts.length > avgPostsPerMonth
    ? 'improving'
    : recentPosts.length < avgPostsPerMonth * 0.5
      ? 'declining'
      : 'stable';

// Calculate objective metrics
const objectiveMetrics = calculateObjectiveMetrics(posts);

// Generate dynamic insights
const insightData = {
  totalPosts: posts.length,
  totalWords: posts.reduce((sum, post) => sum + (post.body || '').split(/\s+/).length, 0),
  avgWordsPerPost: Math.round(
    posts.reduce((sum, post) => sum + (post.body || '').split(/\s+/).length, 0) / posts.length,
  ),
  topTags: Object.entries(
    posts.reduce(
      (acc, post) => {
        post.data.tags?.forEach((tag: string) => {
          acc[tag] = (acc[tag] || 0) + 1;
        });
        return acc;
      },
      {} as Record<string, number>,
    ),
  )
    .sort(([, a], [, b]) => b - a)
    .slice(0, 5)
    .map(([tag, count]) => ({ tag, count })),
  emotionalPosts: 0, // Not calculated for cadence
  growthPosts: 0, // Not calculated for cadence
  complexityTrend: 'stable' as const, // Not calculated for cadence
  productivityTrend: productivityTrend,
  knowledgeAreas: [],
  writingStreaks: sortedStreaks.map((streak) => ({ length: streak.length, days: streak.days })),
  drySpells: sortedDrySpells.map((spell) => ({ days: spell.days })),
  // Add objective metrics
  ...objectiveMetrics,
};

const { insights, summary, balancedAnalysis } = generateDynamicInsights(insightData, 'cadence');

// Prepare time series for posting frequency
const postingFrequencyTimeSeries = {
  labels: monthlyPosts.map((m) => m.label),
  datasets: [
    {
      label: 'Posts Per Month',
      data: monthlyPosts.map((m) => m.count),
      borderColor: 'rgb(var(--color-accent))',
      backgroundColor: 'rgba(var(--color-accent), 0.1)',
    },
  ],
};

// Prepare bar chart for day of week
const dayOfWeekChart = {
  labels: dayOfWeekStats.map((d) => d.shortName),
  datasets: [
    {
      label: 'Posts',
      data: dayOfWeekStats.map((d) => d.count),
      backgroundColor: 'rgba(var(--color-accent), 0.6)',
      borderColor: 'rgb(var(--color-accent))',
    },
  ],
};

// Prepare bar chart for month of year
const monthOfYearChart = {
  labels: monthOfYearStats.map((m) => m.shortName),
  datasets: [
    {
      label: 'Posts',
      data: monthOfYearStats.map((m) => m.count),
      backgroundColor: 'rgba(var(--color-accent), 0.6)',
      borderColor: 'rgb(var(--color-accent))',
    },
  ],
};

// Get page info
const pageInfo = BRAIN_SCIENCE_PAGES.find((p) => p.id === 'cadence');
---

<BaseLayout
  title="Writing Cadence - Brain Science"
  description="Analyzing my publishing patterns, writing streaks, and seasonal rhythms."
  path="/brain-science/cadence"
  structuredDataType="website"
>
  <BrainScienceLayout
    currentPage="/brain-science/cadence"
    title={pageInfo?.title || 'Writing Cadence'}
    description="Quantitative analysis of publishing patterns, posting frequency, and temporal distribution. Statistical analysis of writing cadence using objective metrics."
  >
    {/* Key Metrics with Balanced Indicators */}
    <div
      class="mb-8 grid grid-cols-2 gap-4 md:mb-10 md:grid-cols-2 md:gap-6 lg:mb-12 lg:grid-cols-4"
    >
      <MetricCard
        value={longestStreak}
        label="Longest Streak"
        subtitle="Peak Performance"
        emoji="üèÜ"
        color="text-green-500"
        title="Longest consecutive streak of writings published within 7 days of each other"
      />
      <MetricCard
        value={currentStreak}
        label="Current Streak"
        subtitle="Active Momentum"
        emoji="üî•"
        color="text-blue-500"
        title="Current active streak of writings published within 7 days of each other"
      />
      <MetricCard
        value={sortedDrySpells[0]?.days || 0}
        label="Longest Dry Spell"
        subtitle="Biggest Challenge"
        emoji="‚ö†Ô∏è"
        color="text-red-500"
        title="Longest gap between consecutive writings (days without publishing)"
      />
      <MetricCard
        value={recentPosts.length}
        label="Writings (30 days)"
        subtitle={recentPosts.length > avgPostsPerMonth
          ? 'Above Average'
          : recentPosts.length < avgPostsPerMonth * 0.5
            ? 'Below Average'
            : 'On Track'}
        emoji={recentPosts.length > avgPostsPerMonth
          ? 'üìà'
          : recentPosts.length < avgPostsPerMonth * 0.5
            ? 'üìâ'
            : '‚û°Ô∏è'}
        color={recentPosts.length > avgPostsPerMonth
          ? 'text-green-500'
          : recentPosts.length < avgPostsPerMonth * 0.5
            ? 'text-red-500'
            : 'text-yellow-500'}
        title="Number of writings published in the last 30 days"
      />
    </div>

    {/* Productivity Health Score */}
    <div
      class="mb-6 rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-4 md:mb-8 md:p-6"
    >
      <h3 class="mb-3 text-base font-semibold text-[rgb(var(--color-text))] md:mb-4 md:text-lg">
        üìä Productivity Health Score
      </h3>
      <div class="grid grid-cols-1 gap-4 md:grid-cols-3 md:gap-6">
        <div class="text-center">
          <div
            class="mb-1 text-2xl font-bold text-green-500 md:mb-2 md:text-3xl"
            title="Consistency score calculated as: (number of writing streaks) / (total streaks + dry spells)"
          >
            {Math.round(consistencyScore * 100)}%
          </div>
          <div class="text-xs text-[rgb(var(--color-text-muted))] md:text-sm">
            Consistency Score
          </div>
          <div class="mt-1 text-xs text-[rgb(var(--color-text-muted))]">
            {
              consistencyScore > 0.7
                ? 'Excellent'
                : consistencyScore > 0.4
                  ? 'Good'
                  : 'Needs Improvement'
            }
          </div>
        </div>
        <div class="text-center">
          <div
            class="mb-1 text-2xl font-bold text-blue-500 md:mb-2 md:text-3xl"
            title="Average writings per month calculated as: total writings / (days since first writing / 30)"
          >
            {avgPostsPerMonth}
          </div>
          <div class="text-xs text-[rgb(var(--color-text-muted))] md:text-sm">
            Avg Writings/Month
          </div>
          <div class="mt-1 text-xs text-[rgb(var(--color-text-muted))]">
            {
              avgPostsPerMonth > 4
                ? 'High Output'
                : avgPostsPerMonth > 2
                  ? 'Moderate'
                  : 'Low Output'
            }
          </div>
        </div>
        <div class="text-center">
          <div
            class={`text-2xl md:text-3xl font-bold mb-1 md:mb-2 ${productivityTrend === 'improving' ? 'text-green-500' : productivityTrend === 'declining' ? 'text-red-500' : 'text-yellow-500'}`}
          >
            {
              productivityTrend === 'improving'
                ? '‚ÜóÔ∏è'
                : productivityTrend === 'declining'
                  ? '‚ÜòÔ∏è'
                  : '‚û°Ô∏è'
            }
          </div>
          <div class="text-xs text-[rgb(var(--color-text-muted))] md:text-sm">Trend</div>
          <div class="mt-1 text-xs capitalize text-[rgb(var(--color-text-muted))]">
            {productivityTrend}
          </div>
        </div>
      </div>
    </div>

    {/* Monthly Activity Chart */}
    {
      postingFrequencyTimeSeries.labels.length > 0 && (
        <div class="mb-8 md:mb-10 lg:mb-12">
          <h2 class="mb-4 text-lg font-semibold text-[rgb(var(--color-text))] md:mb-6 md:text-xl">
            üìà Monthly Publishing Frequency
          </h2>
          <p class="mb-6 max-w-3xl text-sm text-[rgb(var(--color-text-muted))]">
            Post count per month over time. Formula: posts_per_month = count(posts where pubDate ‚àà
            [month_start, month_end])
          </p>
          <TimeSeriesChart
            id="monthly-posting-frequency"
            labels={postingFrequencyTimeSeries.labels}
            datasets={postingFrequencyTimeSeries.datasets}
            title="Posts Published Per Month"
            yAxisLabel="Number of Posts"
          />
        </div>
      )
    }

    {/* Day of Week Analysis */}
    <div class="mb-6 grid grid-cols-1 gap-6 md:mb-8 md:gap-8 lg:mb-10 lg:grid-cols-2">
      <div>
        <h3 class="mb-4 text-base font-semibold text-[rgb(var(--color-text))] md:mb-6 md:text-lg">
          Day of Week Distribution
        </h3>
        <p class="mb-4 text-xs text-[rgb(var(--color-text-muted))]">
          Post frequency by day of week. Formula: frequency(day) = count(posts where
          day_of_week(pubDate) = day) / total_posts √ó 100
        </p>
        {
          dayOfWeekChart.labels.length > 0 && (
            <BarChart
              id="day-of-week-chart"
              labels={dayOfWeekChart.labels}
              datasets={dayOfWeekChart.datasets}
              title="Posts by Day of Week"
              yAxisLabel="Post Count"
            />
          )
        }
      </div>

      <div>
        <h3 class="mb-4 text-base font-semibold text-[rgb(var(--color-text))] md:mb-6 md:text-lg">
          Seasonal Distribution
        </h3>
        <p class="mb-4 text-xs text-[rgb(var(--color-text-muted))]">
          Post frequency by month of year. Formula: frequency(month) = count(posts where
          month(pubDate) = month) / total_posts √ó 100
        </p>
        {
          monthOfYearChart.labels.length > 0 && (
            <BarChart
              id="month-of-year-chart"
              labels={monthOfYearChart.labels}
              datasets={monthOfYearChart.datasets}
              title="Posts by Month of Year"
              yAxisLabel="Post Count"
            />
          )
        }
      </div>
    </div>

    {/* Writing Streaks */}
    <div class="mb-6 md:mb-8 lg:mb-10">
      <h3 class="mb-4 text-base font-semibold text-[rgb(var(--color-text))] md:mb-6 md:text-lg">
        üìä Writing Streaks Analysis
      </h3>
      <p class="mb-4 text-xs text-[rgb(var(--color-text-muted))]">
        Consecutive posts published within 7 days of each other. Streak length = count(consecutive
        posts where days_between ‚â§ 7)
      </p>
      <div class="space-y-4">
        {
          sortedStreaks.slice(0, 10).map((streak, index) => (
            <div class="flex items-center justify-between rounded-lg bg-[rgb(var(--color-bg))] p-4">
              <div class="flex items-center gap-4">
                <div
                  class={`text-lg font-bold ${
                    index === 0
                      ? 'text-yellow-500'
                      : index === 1
                        ? 'text-gray-400'
                        : index === 2
                          ? 'text-amber-600'
                          : 'text-[rgb(var(--color-accent))]'
                  }`}
                >
                  {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}
                </div>
                <div>
                  <div class="text-sm font-medium text-[rgb(var(--color-text))]">
                    {streak.length} posts in {streak.days} days
                  </div>
                  <div class="text-xs text-[rgb(var(--color-text-muted))]">
                    {format(streak.startDate, 'MMM d, yyyy')} -{' '}
                    {format(streak.endDate, 'MMM d, yyyy')}
                  </div>
                </div>
              </div>
              <div class="text-right">
                <div
                  class="text-sm font-medium text-[rgb(var(--color-text))]"
                  title="Average posts per day during this streak"
                >
                  {Math.round((streak.length / streak.days) * 100) / 100} posts/day
                </div>
                <div class="text-xs text-[rgb(var(--color-text-muted))]">
                  {streak.length > 5 ? 'üî• Intense' : streak.length > 3 ? '‚ö° Strong' : 'üìù Steady'}
                </div>
              </div>
            </div>
          ))
        }
      </div>
    </div>

    {/* Dry Spells */}
    <div class="mb-6 md:mb-8 lg:mb-10">
      <h3 class="mb-4 text-base font-semibold text-[rgb(var(--color-text))] md:mb-6 md:text-lg">
        üìä Publishing Gaps Analysis
      </h3>
      <p class="mb-4 text-xs text-[rgb(var(--color-text-muted))]">
        Periods with no posts published. Gap duration = days_between(posts) where days_between > 7
      </p>
      <div class="space-y-4">
        {
          sortedDrySpells.slice(0, 5).map((spell, index) => (
            <div class="flex items-center justify-between rounded-lg bg-[rgb(var(--color-bg))] p-4">
              <div class="flex items-center gap-4">
                <div class="text-lg font-bold text-red-500">#{index + 1}</div>
                <div>
                  <div class="text-sm font-medium text-[rgb(var(--color-text))]">
                    {spell.days} days without posting
                  </div>
                  <div class="text-xs text-[rgb(var(--color-text-muted))]">
                    {format(spell.startDate, 'MMM d, yyyy')} -{' '}
                    {format(spell.endDate, 'MMM d, yyyy')}
                  </div>
                </div>
              </div>
              <div class="text-right">
                <div
                  class="text-sm text-[rgb(var(--color-text-muted))]"
                  title="Duration converted to weeks"
                >
                  {Math.round(spell.days / 7)} weeks
                </div>
                <div class="text-xs text-[rgb(var(--color-text-muted))]">
                  {spell.days > 90
                    ? 'üö® Critical'
                    : spell.days > 60
                      ? '‚ö†Ô∏è Concerning'
                      : 'üìâ Notable'}
                </div>
              </div>
            </div>
          ))
        }
      </div>
    </div>

    {/* Most Productive Months */}
    <div class="mb-8">
      <h3 class="mb-6 text-lg font-semibold text-[rgb(var(--color-text))]">
        üìä Months with Highest Post Count
      </h3>
      <p class="mb-4 text-xs text-[rgb(var(--color-text-muted))]">
        Months ranked by post count. Formula: productivity(month) = count(posts where pubDate ‚àà
        month)
      </p>
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
        {
          productiveMonths.map((month, index) => (
            <div class="rounded-lg bg-[rgb(var(--color-bg))] p-4">
              <div class="mb-2 flex items-center justify-between">
                <span class="text-sm font-medium text-[rgb(var(--color-text))]">{month.label}</span>
                <span
                  class={`text-lg font-bold ${
                    index === 0
                      ? 'text-yellow-500'
                      : index === 1
                        ? 'text-gray-400'
                        : index === 2
                          ? 'text-amber-600'
                          : 'text-[rgb(var(--color-accent))]'
                  }`}
                >
                  {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}
                </span>
              </div>
              <div
                class="text-2xl font-bold text-[rgb(var(--color-text))]"
                title={`${month.count} posts published in ${month.label}`}
              >
                {month.count}
              </div>
              <div class="text-xs text-[rgb(var(--color-text-muted))]">posts</div>
            </div>
          ))
        }
      </div>
    </div>

    {/* Balanced Analysis Section */}
    <div class="mb-6 md:mb-8 lg:mb-10">
      <h2
        class="mb-4 flex items-center gap-2 text-lg font-semibold text-[rgb(var(--color-text))] md:mb-6 md:text-xl"
      >
        <span class="text-gray-600 dark:text-gray-400">‚öñÔ∏è</span>
        Balanced Analysis
      </h2>
      <p class="mb-4 text-sm text-[rgb(var(--color-text-muted))] md:mb-6">
        Objective assessment showing strengths, challenges, and neutral metrics without bias toward
        positive outcomes.
      </p>

      {/* Consistency Grades */}
      <div class="mb-6 md:mb-8">
        <h3 class="mb-4 text-lg font-medium text-[rgb(var(--color-text))]">
          üìä Consistency Grades
        </h3>
        <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
          <div>
            <div class="mb-1 text-sm text-[rgb(var(--color-text-muted))]">Posting Regularity</div>
            <div class="mb-1 text-2xl font-bold text-[rgb(var(--color-text))]">
              {objectiveMetrics.consistencyMetrics.postingRegularity}/100
            </div>
            <div class="mb-1 text-xs text-[rgb(var(--color-text-muted))]">
              Formula: 100 - (variance(inter_posting_intervals) / 10)
            </div>
            <div
              class={`text-sm font-semibold ${letterGradeToColor(scoreToLetterGrade(objectiveMetrics.consistencyMetrics.postingRegularity))}`}
            >
              Grade: {scoreToLetterGrade(objectiveMetrics.consistencyMetrics.postingRegularity)}
            </div>
          </div>
          <div>
            <div class="mb-1 text-sm text-[rgb(var(--color-text-muted))]">Topic Consistency</div>
            <div class="mb-1 text-2xl font-bold text-[rgb(var(--color-text))]">
              {objectiveMetrics.consistencyMetrics.topicConsistency}/100
            </div>
            <div class="mb-1 text-xs text-[rgb(var(--color-text-muted))]">
              Formula: (max_tag_frequency / total_posts) √ó 100
            </div>
            <div
              class={`text-sm font-semibold ${letterGradeToColor(scoreToLetterGrade(objectiveMetrics.consistencyMetrics.topicConsistency))}`}
            >
              Grade: {scoreToLetterGrade(objectiveMetrics.consistencyMetrics.topicConsistency)}
            </div>
          </div>
          <div>
            <div class="mb-1 text-sm text-[rgb(var(--color-text-muted))]">Quality Consistency</div>
            <div class="mb-1 text-2xl font-bold text-[rgb(var(--color-text))]">
              {100 - objectiveMetrics.consistencyMetrics.qualityVariance}/100
            </div>
            <div class="mb-1 text-xs text-[rgb(var(--color-text-muted))]">
              Formula: 100 - (variance(word_counts) / 10)
            </div>
            <div
              class={`text-sm font-semibold ${letterGradeToColor(scoreToLetterGrade(100 - objectiveMetrics.consistencyMetrics.qualityVariance))}`}
            >
              Grade: {scoreToLetterGrade(100 - objectiveMetrics.consistencyMetrics.qualityVariance)}
            </div>
          </div>
        </div>
      </div>

      {/* Strengths */}
      {
        balancedAnalysis.strengths.length > 0 && (
          <div class="mb-6 md:mb-8">
            <h3 class="mb-4 text-lg font-medium text-[rgb(var(--color-text))] text-green-600 dark:text-green-400">
              ‚úÖ Strengths
            </h3>
            <div class="space-y-3">
              {balancedAnalysis.strengths.map((insight) => (
                <div class="border-b border-[rgb(var(--color-border))] py-3 last:border-b-0">
                  <div class="text-sm text-[rgb(var(--color-text))]" set:html={insight.text} />
                </div>
              ))}
            </div>
          </div>
        )
      }

      {/* Challenges */}
      {
        balancedAnalysis.challenges.length > 0 && (
          <div class="mb-6 md:mb-8">
            <h3 class="mb-4 text-lg font-medium text-[rgb(var(--color-text))] text-red-600 dark:text-red-400">
              ‚ùå Challenges
            </h3>
            <div class="space-y-3">
              {balancedAnalysis.challenges.map((insight) => (
                <div class="border-b border-[rgb(var(--color-border))] py-3 last:border-b-0">
                  <div class="text-sm text-[rgb(var(--color-text))]" set:html={insight.text} />
                </div>
              ))}
            </div>
          </div>
        )
      }

      {/* Neutral/Objective */}
      {
        balancedAnalysis.neutral.length > 0 && (
          <div class="mb-6 md:mb-8">
            <h3 class="mb-4 text-lg font-medium text-[rgb(var(--color-text))] text-gray-600 dark:text-gray-400">
              ‚ÑπÔ∏è Objective Metrics
            </h3>
            <div class="space-y-3">
              {balancedAnalysis.neutral.map((insight) => (
                <div class="border-b border-[rgb(var(--color-border))] py-3 last:border-b-0">
                  <div class="text-sm text-[rgb(var(--color-text))]" set:html={insight.text} />
                </div>
              ))}
            </div>
          </div>
        )
      }
    </div>

    {/* Analysis Conclusion */}
    <div
      class="rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-4 md:p-6"
    >
      <h3 class="mb-4 text-base font-semibold text-[rgb(var(--color-text))] md:mb-6 md:text-lg">
        üìä Writing Cadence Analysis
      </h3>
      <div class="space-y-4">
        {/* Dynamic Insights */}
        <div class="space-y-2">
          {
            insights.map((insight) => (
              <div class={`flex items-center gap-2 ${insight.color}`}>
                <span class="text-sm">
                  {insight.type === 'positive'
                    ? '‚úÖ'
                    : insight.type === 'negative'
                      ? '‚ùå'
                      : insight.type === 'warning'
                        ? '‚ö†Ô∏è'
                        : '‚ÑπÔ∏è'}
                </span>
                <span class="text-sm" set:html={insight.text} />
              </div>
            ))
          }
        </div>

        {/* Summary */}
        <div class="pt-4">
          <p class="text-sm text-[rgb(var(--color-text-muted))]" set:html={summary} />
        </div>
      </div>
    </div>
  </BrainScienceLayout>
</BaseLayout>
