---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BrainScienceLayout from '../../components/brain-science/BrainScienceLayout.astro';
import MetricCard from '../../components/brain-science/MetricCard.astro';
import TimeSeriesChart from '../../components/brain-science/TimeSeriesChart.astro';
import BarChart from '../../components/brain-science/BarChart.astro';
import {
  getBrainSciencePosts,
  calculateBaseMetrics,
  calculateTagFrequency,
  calculateMaslowAnalysis,
  calculateCurrentMonthPosts,
  calculateStreakMetrics,
  calculateGrowthPosts,
  calculateEmotionalPosts,
  calculateMonthlyPosts,
} from '../../utils/brainScience/data';
import {
  calculateObjectiveMetrics,
  scoreToLetterGrade,
  letterGradeToColor,
} from '../../utils/insightGenerator';
import { BRAIN_SCIENCE_PAGES } from '../../data/brainScience';

// Get all published posts
const posts = await getBrainSciencePosts();

// Calculate base metrics using shared utilities
const baseMetrics = calculateBaseMetrics(posts);
const topTags = calculateTagFrequency(posts, 10);
const maslowAnalysis = calculateMaslowAnalysis(posts);
const thisMonthPosts = calculateCurrentMonthPosts(posts);
const streakMetrics = calculateStreakMetrics(posts);
const growthPosts = calculateGrowthPosts(posts);
const emotionalPosts = calculateEmotionalPosts(posts);

// Calculate objective metrics
const objectiveMetrics = calculateObjectiveMetrics(posts);

// Prepare time series data for post count over time
const monthlyPosts = calculateMonthlyPosts(
  posts,
  baseMetrics.firstPostDate,
  baseMetrics.lastPostDate,
);
const postCountTimeSeries = {
  labels: monthlyPosts.map((m) => m.label),
  datasets: [
    {
      label: 'Posts Published',
      data: monthlyPosts.map((m) => m.count),
      borderColor: 'rgb(var(--color-accent))',
      backgroundColor: 'rgba(var(--color-accent), 0.1)',
    },
  ],
};

// Prepare bar chart data for top tags
const tagBarChart = {
  labels: topTags.slice(0, 10).map((t) => t.tag),
  datasets: [
    {
      label: 'Post Count',
      data: topTags.slice(0, 10).map((t) => t.count),
      backgroundColor: 'rgba(var(--color-accent), 0.6)',
      borderColor: 'rgb(var(--color-accent))',
    },
  ],
};

// Calculate content complexity using compromise.js
const avgWordCount = baseMetrics.averageWordsPerPost;
const avgSentenceLength =
  posts.length > 0
    ? posts.reduce((sum, post) => {
        const content = post.body || '';
        const sentences = content.split(/[.!?]+/).filter((s) => s.trim().length > 0);
        return sum + (sentences.length > 0 ? content.split(/\s+/).length / sentences.length : 0);
      }, 0) / posts.length
    : 0;

// Get page info
const pageInfo = BRAIN_SCIENCE_PAGES.find((p) => p.id === 'index');
---

<BaseLayout
  title="Writing Analytics & Self-Discovery - Brain Science"
  description="Scientific analysis of writing patterns, measurable insights, and data-driven self-discovery. Understanding cognitive patterns through quantitative content analysis."
  path="/brain-science"
  structuredDataType="website"
>
  <BrainScienceLayout
    currentPage="/brain-science"
    title={pageInfo?.title || 'Writing Analytics & Self-Discovery'}
    description="Objective analysis of writing patterns through balanced metrics and quantitative content analysis. This section provides unbiased assessment of cognitive patterns, emotional processing, and intellectual evolution using data-driven methodologies that include positive, neutral, and negative signal analysis."
  >
    {/* Measurable Metrics Grid */}
    <div
      class="mb-8 grid grid-cols-2 gap-4 md:mb-10 md:grid-cols-2 md:gap-6 lg:mb-12 lg:grid-cols-4"
    >
      <MetricCard
        value={baseMetrics.totalPosts}
        label="Total Posts"
        subtitle="Published Content"
        emoji="üìä"
        color="text-blue-500"
        title="Total number of published writings. Formula: count(posts where published = true and draft = false)"
      />
      <MetricCard
        value={baseMetrics.totalWords}
        label="Total Words"
        subtitle="Content Volume"
        emoji="üìù"
        color="text-green-500"
        title="Sum of all words across all published posts. Formula: Œ£(word_count) where word_count = split(content, ' ').length"
      />
      <MetricCard
        value={growthPosts}
        label="Growth Posts"
        subtitle="Transformation Content"
        emoji="üå±"
        color="text-purple-500"
        title="Posts containing growth-related tags or keywords. Formula: count(posts where tags ‚à© growth_tags ‚â† ‚àÖ OR content contains growth_keywords)"
      />
      <MetricCard
        value={emotionalPosts}
        label="Emotional Posts"
        subtitle="High Intensity Content"
        emoji="üíú"
        color="text-pink-500"
        title="Posts with emotional intensity > 5. Formula: count(posts where exclamation_count + emotional_word_count > 5)"
      />
    </div>

    {/* Publishing Activity Over Time */}
    {
      postCountTimeSeries.labels.length > 0 && (
        <div class="mb-8 md:mb-10 lg:mb-12">
          <h2 class="mb-4 text-lg font-semibold text-[rgb(var(--color-text))] md:mb-6 md:text-xl">
            üìà Publishing Activity Over Time
          </h2>
          <p class="mb-6 max-w-3xl text-sm text-[rgb(var(--color-text-muted))]">
            Monthly post count trend. Data shows publishing frequency over time. Formula:
            posts_per_month = count(posts where pubDate ‚àà [month_start, month_end])
          </p>
          <TimeSeriesChart
            id="post-count-timeline"
            labels={postCountTimeSeries.labels}
            datasets={postCountTimeSeries.datasets}
            title="Posts Published Per Month"
            yAxisLabel="Number of Posts"
          />
        </div>
      )
    }

    {/* Top Topics Distribution */}
    {
      tagBarChart.labels.length > 0 && (
        <div class="mb-8 md:mb-10 lg:mb-12">
          <h2 class="mb-4 text-lg font-semibold text-[rgb(var(--color-text))] md:mb-6 md:text-xl">
            üè∑Ô∏è Topic Frequency Distribution
          </h2>
          <p class="mb-6 max-w-3xl text-sm text-[rgb(var(--color-text-muted))]">
            Most frequently used tags across all posts. Formula: frequency(tag) = count(posts where
            tag ‚àà post.tags) / total_posts √ó 100
          </p>
          <BarChart
            id="tag-frequency-chart"
            labels={tagBarChart.labels}
            datasets={tagBarChart.datasets}
            title="Top 10 Tags by Frequency"
            yAxisLabel="Post Count"
            xAxisLabel="Tag"
          />
        </div>
      )
    }

    {/* Publishing Activity Metrics */}
    <div class="mb-8 grid grid-cols-1 gap-4 md:mb-10 md:grid-cols-3 md:gap-6 lg:mb-12">
      <MetricCard
        value={thisMonthPosts}
        label="This Month's Insights"
        title="Number of writings published in the current month"
        class="text-center"
      />
      <MetricCard
        value={streakMetrics.currentStreak}
        label="Current Publishing Streak"
        title="Current writing streak (consecutive writings within 7 days of each other)"
        class="text-center"
      />
      <MetricCard
        value={streakMetrics.longestStreak}
        label="Longest Publishing Period"
        title="Longest writing streak achieved (consecutive writings within 7 days of each other)"
        class="text-center"
      />
    </div>

    {/* Objective Analysis Section */}
    <div class="mb-12 md:mb-16">
      <h2
        class="mb-4 flex items-center gap-2 text-lg font-semibold text-[rgb(var(--color-text))] md:mb-6 md:text-xl"
      >
        <span class="text-gray-600 dark:text-gray-400">‚öñÔ∏è</span>
        Objective Analysis
      </h2>
      <p class="mb-6 max-w-3xl text-sm text-[rgb(var(--color-text-muted))] md:mb-8">
        Quantitative analysis using statistical methods. Metrics calculated using objective formulas
        without bias toward positive or negative outcomes. All calculations are mathematically
        verifiable.
      </p>

      {/* Sentiment Analysis */}
      <div class="mb-6 md:mb-8">
        <h3 class="mb-3 text-base font-medium text-[rgb(var(--color-text))] md:mb-4 md:text-lg">
          Sentiment Distribution Analysis
        </h3>
        <p class="mb-4 text-xs text-[rgb(var(--color-text-muted))]">
          Classification based on word frequency analysis. Formula: sentiment = classify(post) where
          classification uses positive_words, negative_words, and neutral_words dictionaries.
        </p>
        <div class="grid grid-cols-2 gap-4 md:grid-cols-4 md:gap-6">
          <div
            class="rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-3 text-center md:p-4"
          >
            <div class="mb-1 text-xl font-bold text-green-600 dark:text-green-400 md:text-2xl">
              {objectiveMetrics.sentimentAnalysis.positive}
            </div>
            <div class="text-xs text-green-600 dark:text-green-400 md:text-sm">Positive</div>
          </div>
          <div
            class="rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-3 text-center md:p-4"
          >
            <div class="mb-1 text-xl font-bold text-red-600 dark:text-red-400 md:text-2xl">
              {objectiveMetrics.sentimentAnalysis.negative}
            </div>
            <div class="text-xs text-red-600 dark:text-red-400 md:text-sm">Negative</div>
          </div>
          <div
            class="rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-3 text-center md:p-4"
          >
            <div class="mb-1 text-xl font-bold text-blue-600 dark:text-blue-400 md:text-2xl">
              {objectiveMetrics.sentimentAnalysis.neutral}
            </div>
            <div class="text-xs text-blue-600 dark:text-blue-400 md:text-sm">Neutral</div>
          </div>
          <div
            class="rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-3 text-center md:p-4"
          >
            <div class="mb-1 text-xl font-bold text-gray-600 dark:text-gray-400 md:text-2xl">
              {objectiveMetrics.sentimentAnalysis.mixed}
            </div>
            <div class="text-xs text-gray-600 dark:text-gray-400 md:text-sm">Mixed</div>
          </div>
        </div>
      </div>

      {/* Consistency Metrics */}
      <div class="mb-6 md:mb-8">
        <h3 class="mb-3 text-base font-medium text-[rgb(var(--color-text))] md:mb-4 md:text-lg">
          Consistency Metrics
        </h3>
        <p class="mb-4 text-xs text-[rgb(var(--color-text-muted))]">
          Statistical measures of regularity. Posting Regularity: 100 -
          (variance(inter_posting_intervals) / 10). Topic Consistency: (max_tag_frequency /
          total_posts) √ó 100. Quality Variance: variance(word_counts) / 10.
        </p>
        <div class="grid grid-cols-1 gap-4 md:grid-cols-3 md:gap-6">
          <div
            class="rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-4 md:p-6"
          >
            <div class="mb-1 text-xs text-[rgb(var(--color-text-muted))] md:text-sm">
              Posting Regularity
            </div>
            <div class="mb-1 text-xl font-bold text-[rgb(var(--color-text))] md:text-2xl">
              {objectiveMetrics.consistencyMetrics.postingRegularity}/100
            </div>
            <div
              class={`text-xs md:text-sm font-semibold ${letterGradeToColor(scoreToLetterGrade(objectiveMetrics.consistencyMetrics.postingRegularity))}`}
            >
              Grade: {scoreToLetterGrade(objectiveMetrics.consistencyMetrics.postingRegularity)}
            </div>
          </div>
          <div
            class="rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-4 md:p-6"
          >
            <div class="mb-1 text-xs text-[rgb(var(--color-text-muted))] md:text-sm">
              Topic Consistency
            </div>
            <div class="mb-1 text-xl font-bold text-[rgb(var(--color-text))] md:text-2xl">
              {objectiveMetrics.consistencyMetrics.topicConsistency}/100
            </div>
            <div
              class={`text-xs md:text-sm font-semibold ${letterGradeToColor(scoreToLetterGrade(objectiveMetrics.consistencyMetrics.topicConsistency))}`}
            >
              Grade: {scoreToLetterGrade(objectiveMetrics.consistencyMetrics.topicConsistency)}
            </div>
          </div>
          <div
            class="rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-4 md:p-6"
          >
            <div class="mb-1 text-xs text-[rgb(var(--color-text-muted))] md:text-sm">
              Quality Variance
            </div>
            <div class="mb-1 text-xl font-bold text-[rgb(var(--color-text))] md:text-2xl">
              {objectiveMetrics.consistencyMetrics.qualityVariance}/100
            </div>
            <div
              class={`text-xs md:text-sm font-semibold ${letterGradeToColor(scoreToLetterGrade(100 - objectiveMetrics.consistencyMetrics.qualityVariance))}`}
            >
              Grade: {scoreToLetterGrade(100 - objectiveMetrics.consistencyMetrics.qualityVariance)}
            </div>
          </div>
        </div>
      </div>

      {/* Challenge Areas */}
      {
        objectiveMetrics.challengeAreas.length > 0 && (
          <div class="mb-6 md:mb-8">
            <h3 class="mb-3 text-base font-medium text-[rgb(var(--color-text))] md:mb-4 md:text-lg">
              Challenge Areas
            </h3>
            <div class="space-y-2 overflow-hidden rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] md:space-y-3">
              {objectiveMetrics.challengeAreas.map((challenge) => (
                <div class="flex items-center justify-between border-b border-[rgb(var(--color-border))] px-4 py-3 last:border-b-0 md:px-6 md:py-4">
                  <div>
                    <span class="text-sm font-medium text-[rgb(var(--color-text))] md:text-base">
                      {challenge.area}
                    </span>
                    <div class="text-xs text-[rgb(var(--color-text-muted))] md:text-sm">
                      Frequency: {challenge.frequency}%
                    </div>
                  </div>
                  <span
                    class={`rounded-full px-2 py-1 text-xs md:px-3 md:text-sm ${
                      challenge.severity === 'high'
                        ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300'
                        : challenge.severity === 'medium'
                          ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300'
                          : 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300'
                    }`}
                  >
                    {challenge.severity}
                  </span>
                </div>
              ))}
            </div>
          </div>
        )
      }

      {/* Improvement Areas */}
      {
        objectiveMetrics.improvementAreas.length > 0 && (
          <div class="mb-6 md:mb-8">
            <h3 class="mb-3 text-base font-medium text-[rgb(var(--color-text))] md:mb-4 md:text-lg">
              Improvement Opportunities
            </h3>
            <div class="space-y-3 rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-4 md:space-y-4 md:p-6">
              {objectiveMetrics.improvementAreas.map((improvement) => (
                <div>
                  <div class="mb-2 flex items-center justify-between">
                    <span class="text-sm font-medium text-[rgb(var(--color-text))] md:text-base">
                      {improvement.area}
                    </span>
                    <span class="text-xs text-[rgb(var(--color-text-muted))] md:text-sm">
                      {improvement.current} / {improvement.target}
                    </span>
                  </div>
                  <div class="mb-1 h-2 w-full rounded-full bg-gray-200 dark:bg-gray-700">
                    <div
                      class="h-2 rounded-full bg-blue-500 transition-all duration-300"
                      style={`width: ${Math.min(100, (improvement.current / improvement.target) * 100)}%`}
                    />
                  </div>
                  <div class="text-xs text-[rgb(var(--color-text-muted))] md:text-sm">
                    Gap: {improvement.gap.toFixed(1)}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )
      }
    </div>

    {/* Data Insights */}
    <div class="mb-12 grid grid-cols-1 gap-6 md:mb-16 md:gap-8 lg:grid-cols-2">
      {/* Core Themes */}
      <div
        class="rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-4 md:p-6"
      >
        <h3 class="mb-3 text-base font-semibold text-[rgb(var(--color-text))] md:mb-4 md:text-lg">
          Topic Frequency Analysis
        </h3>
        <p class="mb-4 text-xs text-[rgb(var(--color-text-muted))]">
          Most frequently occurring tags. Formula: frequency(tag) = count(posts with tag) /
          total_posts
        </p>
        <div class="space-y-2 md:space-y-3">
          {
            topTags.map(({ tag, count }) => (
              <div class="flex items-center justify-between">
                <span class="text-xs font-medium text-[rgb(var(--color-text))] md:text-sm">
                  {tag}
                </span>
                <div class="flex items-center gap-2">
                  <div class="h-2 w-12 rounded-full bg-[rgb(var(--color-border))] md:w-16">
                    <div
                      class="h-2 rounded-full bg-[rgb(var(--color-accent))]"
                      style={`width: ${topTags[0] ? (count / topTags[0].count) * 100 : 0}%`}
                      title={`${count} posts (${Math.round((count / posts.length) * 100)}% of total)`}
                    />
                  </div>
                  <span
                    class="w-6 text-right text-xs text-[rgb(var(--color-text-muted))] md:w-8"
                    title={`${count} posts tagged with "${tag}"`}
                  >
                    {count}
                  </span>
                </div>
              </div>
            ))
          }
        </div>
      </div>

      {/* Life Areas Focus */}
      <div
        class="rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-secondary))] p-4 md:p-6"
      >
        <h3 class="mb-3 text-base font-semibold text-[rgb(var(--color-text))] md:mb-4 md:text-lg">
          Maslow Hierarchy Distribution
        </h3>
        <p class="mb-4 text-xs text-[rgb(var(--color-text-muted))]">
          Content distribution across Maslow's hierarchy categories. Formula: category_percentage =
          (posts_in_category / total_posts) √ó 100
        </p>
        <div class="space-y-2 md:space-y-3">
          {
            maslowAnalysis.map((category) => (
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-base md:text-lg">{category.icon}</span>
                  <span class="text-xs font-medium text-[rgb(var(--color-text))] md:text-sm">
                    {category.title}
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="h-2 w-12 rounded-full bg-[rgb(var(--color-border))] md:w-16">
                    <div
                      class="h-2 rounded-full"
                      style={`width: ${category.percentage}%; background-color: rgb(var(--color-accent))`}
                      title={`${category.postCount} posts (${category.percentage}% of total)`}
                    />
                  </div>
                  <span
                    class="w-6 text-right text-xs text-[rgb(var(--color-text-muted))] md:w-8"
                    title={`${category.postCount} posts (${category.percentage}% of total) in ${category.title} category`}
                  >
                    {category.percentage}%
                  </span>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </BrainScienceLayout>
</BaseLayout>
