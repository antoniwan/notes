---
import BaseLayout from './BaseLayout.astro';
import PageHeader from '../components/PageHeader.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Comments from '../components/Comments.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import Container from '../components/Container.astro';
import DefaultImage from '../components/DefaultImage.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import SocialShare from '../components/SocialShare.astro';
import LanguageToggle from '../components/LanguageToggle.astro';
import { generateCanonicalUrl } from '../utils/seo';
import type { BlogLayoutProps } from '../types/layout';

interface Props extends BlogLayoutProps {}

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  minutesRead,
  tags,
  category,
  categoryName,
  path,
  imageAlt,
  author,
  keywords,
  tableOfContents,
  showComments = true,
  translationData,
  ...rest
} = Astro.props;

// Generate canonical URL automatically
const canonical = path || generateCanonicalUrl(Astro.url.pathname);

// Use Astro's native post.id directly (no regex, no normalization)
const postId = rest.currentPost?.id || '';
const postSlug = postId; // Alias for backward compatibility in template
---

<BaseLayout
  title={title}
  description={description}
  pubDate={pubDate}
  updatedDate={updatedDate}
  heroImage={heroImage}
  minutesRead={minutesRead}
  tags={tags}
  category={category}
  path={canonical}
  imageAlt={imageAlt}
  author={author}
  keywords={keywords}
  type="article"
  structuredDataType="article"
  tableOfContents={tableOfContents}
  hasComments={showComments}
  featured={rest.featured}
  draft={rest.draft}
  postId={postId}
  {...rest}
>
  <Container>
    <div class="py-6 md:py-8 lg:py-12">
      {/* Breadcrumbs - Hidden on mobile, visible on desktop */}
      <div class="mb-6 hidden md:block">
        <Breadcrumbs
          items={[
            { label: 'Home', href: '/' },
            ...(categoryName && category && category.length > 0
              ? [{ label: categoryName, href: `/category/${category[0]}/` }]
              : []),
            { label: title },
          ]}
          class="text-sm"
        />
      </div>

      {/* Hero Section - Full width on mobile, moves to sidebar on desktop */}
      <div class="mb-8 md:mb-12 lg:hidden">
        <PageHeader
          title={title}
          description={description}
          className="!mb-6"
          transition:name="page-title"
        />
      </div>

      {/* Main Layout: Mobile-first, then 75/25 on desktop */}
      <div class="lg:grid lg:grid-cols-4 lg:gap-8 xl:gap-12">
        {/* Sidebar - Hidden on mobile, visible on desktop */}
        <aside class="hidden lg:col-span-1 lg:block">
          <div class="sticky top-8 space-y-8 pt-12">
            {/* Post Title & Description - Only shown in sidebar on desktop */}
            <div class="space-y-2">
              <h1
                class="mb-6 text-2xl font-bold text-[rgb(var(--color-text))]"
                transition:name="page-title"
                style="line-height: 1.3; margin-bottom: 1.5rem;"
              >
                {title}
              </h1>
              {
                description && (
                  <p class="text-body-muted text-base" style="line-height: 1.6; margin: 0;">
                    {description}
                  </p>
                )
              }
            </div>

            {/* Social Share - Desktop Sidebar (Moved up for immediate access) */}
            <SocialShare
              title={title}
              description={description}
              url={canonical}
              variant="vertical"
            />

            {/* Post Metadata */}
            <div class="space-y-6" style="line-height: 1.6;">
              {/* Publication Date */}
              {
                pubDate && (
                  <div class="space-y-2">
                    <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                      Published
                    </h3>
                    <time
                      datetime={pubDate.toISOString()}
                      class="flex items-center gap-2 text-base leading-relaxed text-[rgb(var(--color-text))]"
                    >
                      <span class="text-[rgb(var(--color-accent))]">üìÖ</span>
                      <FormattedDate date={pubDate} format="long" />
                    </time>
                  </div>
                )
              }

              {/* Updated Date */}
              {
                updatedDate && updatedDate.getTime() !== pubDate?.getTime() && (
                  <div class="space-y-2">
                    <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                      Updated
                    </h3>
                    <time
                      datetime={updatedDate.toISOString()}
                      class="flex items-center gap-2 text-base leading-relaxed text-[rgb(var(--color-text))]"
                    >
                      <span class="text-[rgb(var(--color-accent))]">üîÑ</span>
                      <FormattedDate date={updatedDate} format="long" />
                    </time>
                  </div>
                )
              }

              {/* Reading Time */}
              {
                minutesRead && (
                  <div
                    class="reading-time-section space-y-2"
                    data-post-slug={postSlug}
                    data-original-reading-time={minutesRead}
                  >
                    <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                      Reading Time
                    </h3>
                    <div class="flex items-center gap-2 text-base leading-relaxed text-[rgb(var(--color-text))]">
                      <span class="reading-time-icon text-[rgb(var(--color-accent))]">‚è±Ô∏è</span>
                      <span class="reading-time-value">{minutesRead}</span>
                    </div>
                  </div>
                )
              }

              {/* Category */}
              {
                categoryName && category && category.length > 0 && (
                  <div class="space-y-2">
                    <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                      Category
                    </h3>
                    <div class="flex items-center gap-2 text-base leading-relaxed">
                      <span class="text-[rgb(var(--color-accent))]">üìÅ</span>
                      <a
                        href={`/category/${category[0]}/`}
                        class="theme-transition text-[rgb(var(--color-text))] hover:text-[rgb(var(--color-accent))]"
                      >
                        {categoryName}
                      </a>
                    </div>
                  </div>
                )
              }

              {/* Tags */}
              {
                tags && tags.length > 0 && (
                  <div class="space-y-2">
                    <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                      Tags
                    </h3>
                    <div class="flex flex-wrap gap-1 text-sm">
                      {tags.map((tag) => (
                        <a
                          href={`/tag/${tag}/`}
                          class="text-[rgb(var(--color-accent))] transition-colors hover:text-[rgb(var(--color-accent))]/80 hover:underline"
                        >
                          #{tag}
                        </a>
                      ))}
                    </div>
                  </div>
                )
              }
            </div>
          </div>
        </aside>

        {/* Main Content Area - Full width on mobile, 75% on desktop */}
        <main class="lg:col-span-3">
          {/* Hero Image - First thing in main content */}
          <div class="mb-8 md:mb-12">
            {
              heroImage ? (
                <img
                  src={heroImage}
                  alt={imageAlt || title}
                  class="h-[450px] w-full rounded-lg object-cover shadow-lg md:rounded-xl"
                  loading="eager"
                  fetchpriority="high"
                  decoding="async"
                  width="1200"
                  height="450"
                />
              ) : (
                <DefaultImage
                  alt={imageAlt || title}
                  className="w-full h-[450px] object-cover rounded-lg shadow-lg md:rounded-xl"
                  loading="eager"
                  priority={true}
                />
              )
            }
          </div>

          {/* Language Toggle */}
          {
            translationData?.hasTranslations && (
              <LanguageToggle
                translations={translationData.translations}
                currentLanguage={translationData.currentLanguage}
                currentPath={translationData.currentPath}
              />
            )
          }

          {/* Content */}
          <div
            class="prose prose-lg max-w-none prose-headings:scroll-mt-20"
            transition:name="page-content"
          >
            <slot />
          </div>

          {/* Social Share - Tablet Horizontal Bar */}
          <SocialShare
            title={title}
            description={description}
            url={canonical}
            variant="horizontal"
          />

          {/* Mobile-only metadata - shown after content on mobile */}
          <div class="mt-12 space-y-6 border-t border-[rgb(var(--color-border))] pt-8 lg:hidden">
            {/* Publication Date */}
            {
              pubDate && (
                <div class="space-y-2">
                  <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                    Published
                  </h3>
                  <time
                    datetime={pubDate.toISOString()}
                    class="flex items-center gap-2 text-base leading-relaxed text-[rgb(var(--color-text))]"
                  >
                    <span class="text-[rgb(var(--color-accent))]">üìÖ</span>
                    <FormattedDate date={pubDate} format="long" />
                  </time>
                </div>
              )
            }

            {/* Updated Date */}
            {
              updatedDate && updatedDate.getTime() !== pubDate?.getTime() && (
                <div class="space-y-2">
                  <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                    Updated
                  </h3>
                  <time
                    datetime={updatedDate.toISOString()}
                    class="flex items-center gap-2 text-base leading-relaxed text-[rgb(var(--color-text))]"
                  >
                    <span class="text-[rgb(var(--color-accent))]">üîÑ</span>
                    <FormattedDate date={updatedDate} format="long" />
                  </time>
                </div>
              )
            }

            {/* Reading Time */}
            {
              minutesRead && (
                <div
                  class="reading-time-section space-y-2"
                  data-post-slug={postSlug}
                  data-original-reading-time={minutesRead}
                >
                  <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                    Reading Time
                  </h3>
                  <div class="flex items-center gap-2 text-base leading-relaxed text-[rgb(var(--color-text))]">
                    <span class="reading-time-icon text-[rgb(var(--color-text))]">‚è±Ô∏è</span>
                    <span class="reading-time-value">{minutesRead}</span>
                  </div>
                </div>
              )
            }

            {/* Category */}
            {
              categoryName && category && category.length > 0 && (
                <div class="space-y-2">
                  <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                    Category
                  </h3>
                  <div class="flex items-center gap-2 text-base leading-relaxed">
                    <span class="text-[rgb(var(--color-accent))]">üìÅ</span>
                    <a
                      href={`/category/${category[0]}/`}
                      class="theme-transition text-[rgb(var(--color-text))] hover:text-[rgb(var(--color-accent))]"
                    >
                      {categoryName}
                    </a>
                  </div>
                </div>
              )
            }

            {/* Tags */}
            {
              tags && tags.length > 0 && (
                <div class="space-y-2">
                  <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                    Tags
                  </h3>
                  <div class="flex flex-wrap gap-1 text-sm">
                    {tags.map((tag) => (
                      <a
                        href={`/tag/${tag}/`}
                        class="text-[rgb(var(--color-accent))] transition-colors hover:text-[rgb(var(--color-accent))]/80 hover:underline"
                      >
                        #{tag}
                      </a>
                    ))}
                  </div>
                </div>
              )
            }

            {/* Author */}
            {
              author && (
                <div class="space-y-2">
                  <h3 class="text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]">
                    Author
                  </h3>
                  <div class="flex items-center gap-2 text-base leading-relaxed text-[rgb(var(--color-text))]">
                    <span class="text-[rgb(var(--color-accent))]">‚úçÔ∏è</span>
                    <span>{author}</span>
                  </div>
                </div>
              )
            }
          </div>

          {/* Comments */}
          {showComments && <Comments />}

          <RelatedPosts currentPost={rest.currentPost} allPosts={rest.allPosts} />
        </main>
      </div>
    </div>
  </Container>
</BaseLayout>

<script define:vars={{ postSlug }}>
  import { formatRelativeReadTime } from '../utils/relativeReadTime.client';

  // ReadStateService is initialized by ReadStateServiceInit component in BaseLayout
  // Get the singleton instance
  const readStateService = window.ReadStateService?.getInstance();

  function updateReadStatus() {
    if (!readStateService) return; // Exit early if service not available
    const readData = readStateService.getReadData(postSlug);

    // Reading time sections (both desktop and mobile)
    const readingTimeSections = document.querySelectorAll(
      `.reading-time-section[data-post-slug="${postSlug}"]`,
    );

    if (readData) {
      const relativeTime = formatRelativeReadTime(readData.readAt);

      // Update reading time sections to show relative time
      readingTimeSections.forEach((section) => {
        const timeValueElement = section.querySelector('.reading-time-value');
        const iconElement = section.querySelector('.reading-time-icon');

        if (timeValueElement) {
          timeValueElement.textContent = relativeTime;
          timeValueElement.setAttribute('datetime', readData.readAt);
        }

        // Change the icon to indicate read status
        if (iconElement) {
          iconElement.textContent = '‚úì';
          iconElement.classList.remove(
            'text-[rgb(var(--color-accent))]',
            'text-[rgb(var(--color-text))]',
          );
          iconElement.classList.add('text-[rgb(34,197,94)]');
        }
      });
    } else {
      // Restore original reading time for unread posts
      readingTimeSections.forEach((section) => {
        const originalReadingTime = section.getAttribute('data-original-reading-time');
        const timeValueElement = section.querySelector('.reading-time-value');
        const iconElement = section.querySelector('.reading-time-icon');

        if (timeValueElement && originalReadingTime) {
          timeValueElement.textContent = originalReadingTime;
          timeValueElement.removeAttribute('datetime');
        }

        // Restore the icon
        if (iconElement) {
          iconElement.textContent = '‚è±Ô∏è';
          iconElement.classList.remove('text-[rgb(34,197,94)]');
          // Restore original color based on context (desktop has accent, mobile has text)
          const isMobile = section.closest('.lg\\:hidden');
          if (isMobile) {
            iconElement.classList.add('text-[rgb(var(--color-text))]');
          } else {
            iconElement.classList.add('text-[rgb(var(--color-accent))]');
          }
        }
      });
    }
  }

  // Subscribe to read state changes (only if service is available)
  let unsubscribe = null;
  if (readStateService) {
    unsubscribe = readStateService.subscribeToAll(() => {
      updateReadStatus();
    });

    // Initial update
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateReadStatus);
    } else {
      updateReadStatus();
    }
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (unsubscribe) {
      unsubscribe();
    }
  });
</script>
