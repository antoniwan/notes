---
import PostCard from './PostCard.astro';
import PostListItem from './PostListItem.astro';

interface Props {
  posts: any[];
  initialCount?: number;
  loadMoreCount?: number;
}

const { posts, initialCount = 6, loadMoreCount = 6 } = Astro.props;
---

<div class="lazy-posts-container" data-initial-count={initialCount} data-load-count={loadMoreCount}>
  <!-- Grid View -->
  <div
    class="posts-grid-view postcards-grid grid grid-cols-1 gap-6 md:grid-cols-3 md:gap-8"
    id="posts-grid"
    data-total-posts={posts.length}
  >
    {
      posts.map((post, index) => (
        <div class={`post-item ${index < initialCount ? 'visible' : 'hidden'}`} data-index={index}>
          <PostCard post={post} featured={post.data.featured} />
        </div>
      ))
    }
  </div>

  <!-- List View -->
  <div class="posts-list-view hidden" id="posts-list">
    <!-- Sorting Controls (only visible in list view) -->
    <div
      class="list-sorting-controls mb-4 flex flex-wrap items-center gap-4 rounded-lg border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg-alt))] p-4"
    >
      <label class="text-sm font-medium text-[rgb(var(--color-text))]">Sort by:</label>
      <select
        class="sort-select rounded border border-[rgb(var(--color-border))] bg-[rgb(var(--color-bg))] px-3 py-2 text-sm text-[rgb(var(--color-text))] focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-primary))]"
        id="sort-select"
      >
        <option value="date-desc">Date (Newest First)</option>
        <option value="date-asc">Date (Oldest First)</option>
        <option value="title-asc">Title (A-Z)</option>
        <option value="title-desc">Title (Z-A)</option>
        <option value="reading-time-desc">Reading Time (Longest First)</option>
        <option value="reading-time-asc">Reading Time (Shortest First)</option>
        <option value="category-asc">Category (A-Z)</option>
        <option value="category-desc">Category (Z-A)</option>
      </select>
    </div>

    <!-- List Table -->
    <div class="list-table-container overflow-x-auto">
      <table class="w-full border-collapse" id="posts-table">
        <thead>
          <tr class="border-b-2 border-[rgb(var(--color-border))]">
            <th
              class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]"
            >
              Title
            </th>
            <th
              class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]"
            >
              Date
            </th>
            <th
              class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]"
            >
              Reading Time
            </th>
            <th
              class="px-2 py-3 text-left text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]"
            >
              Category
            </th>
            <th
              class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider text-[rgb(var(--color-text-muted))]"
            >
              Featured
            </th>
          </tr>
        </thead>
        <tbody id="posts-table-body">
          {posts.map((post, index) => <PostListItem post={post} />)}
        </tbody>
      </table>
    </div>
  </div>

  {
    posts.length > initialCount && (
      <div class="load-more-container mt-12 text-center" id="load-more-container">
        <div
          class="progress-indicator mb-4 text-base leading-relaxed text-[rgb(var(--color-text-muted))]"
          id="progress-indicator"
        >
          Showing {initialCount} of {posts.length} writings (
          {Math.round((initialCount / posts.length) * 100)}% complete)
        </div>
        <button
          class="load-more-btn rounded-lg bg-[rgb(var(--color-primary))] px-8 py-3 text-base font-medium leading-relaxed text-white transition-colors duration-200 hover:bg-[rgb(var(--color-primary-hover))] focus:outline-none focus:ring-2 focus:ring-[rgb(var(--color-primary))] focus:ring-offset-2"
          id="load-more-btn"
          data-total-posts={posts.length}
          data-current-count={initialCount}
          data-load-count={loadMoreCount}
        >
          Load More Writings
        </button>
        <div class="loading-spinner mt-4 hidden" id="loading-spinner">
          <div class="inline-block h-6 w-6 animate-spin rounded-full border-b-2 border-[rgb(var(--color-primary))]" />
          <span class="ml-2 text-base leading-relaxed text-[rgb(var(--color-text-muted))]">
            Loading...
          </span>
        </div>
      </div>
    )
  }
</div>

<script>
  type SortOption =
    | 'date-desc'
    | 'date-asc'
    | 'title-asc'
    | 'title-desc'
    | 'reading-time-desc'
    | 'reading-time-asc'
    | 'category-asc'
    | 'category-desc';

  class LazyPosts {
    private container: HTMLElement | null;
    private postsGrid: HTMLElement | null;
    private postsList: HTMLElement | null;
    private postsTableBody: HTMLElement | null;
    private loadMoreBtn: HTMLButtonElement | null;
    private loadMoreContainer: HTMLElement | null;
    private loadingSpinner: HTMLElement | null;
    private progressIndicator: HTMLElement | null;
    private sortSelect: HTMLSelectElement | null;
    private currentView: 'grid' | 'list' = 'grid';
    private isLoading: boolean = false;
    private currentSort: SortOption = 'date-desc';
    private initialCount: number = 12;

    constructor() {
      this.container = document.querySelector('.lazy-posts-container');
      this.postsGrid = document.getElementById('posts-grid');
      this.postsList = document.getElementById('posts-list');
      this.postsTableBody = document.getElementById('posts-table-body');
      this.loadMoreBtn = document.getElementById('load-more-btn') as HTMLButtonElement;
      this.loadMoreContainer = document.getElementById('load-more-container');
      this.loadingSpinner = document.getElementById('loading-spinner');
      this.progressIndicator = document.getElementById('progress-indicator');
      this.sortSelect = document.getElementById('sort-select') as HTMLSelectElement;

      // Get initial count from data attribute
      if (this.container) {
        this.initialCount = parseInt(this.container.dataset.initialCount || '12');
      }

      // Listen for view mode changes from ViewToggle
      window.addEventListener('viewModeChange', ((e: Event) => {
        const customEvent = e as CustomEvent<{ viewMode: 'grid' | 'list' }>;
        if (customEvent.detail?.viewMode) {
          this.switchView(customEvent.detail.viewMode);
        }
      }) as EventListener);

      // Handle sorting
      if (this.sortSelect) {
        this.sortSelect.addEventListener('change', (e) => {
          const target = e.target as HTMLSelectElement;
          this.sortPosts(target.value as SortOption);
        });
      }

      if (this.loadMoreBtn) {
        this.loadMoreBtn.addEventListener('click', () => this.loadMorePosts().catch(() => {}));
      }

      // Initialize with stored view or default
      this.initializeView();
      this.initInfiniteScroll();
    }

    initializeView() {
      try {
        const stored = localStorage.getItem('everything-view-mode');
        if (stored === 'grid' || stored === 'list') {
          this.currentView = stored;
        }
      } catch (e) {
        // Ignore localStorage errors
      }

      // Initialize list items visibility
      this.initializeListItems();
      this.switchView(this.currentView);
    }

    initializeListItems() {
      if (!this.postsTableBody) return;

      const rows = this.postsTableBody.querySelectorAll('.post-list-item');

      rows.forEach((row, index) => {
        const rowEl = row as HTMLElement;
        if (index < this.initialCount) {
          rowEl.style.display = '';
        } else {
          rowEl.style.display = 'none';
        }
      });
    }

    switchView(viewMode: 'grid' | 'list') {
      this.currentView = viewMode;

      if (viewMode === 'grid') {
        this.postsGrid?.classList.remove('hidden');
        this.postsList?.classList.add('hidden');
      } else {
        this.postsGrid?.classList.add('hidden');
        this.postsList?.classList.remove('hidden');
        // Re-initialize list items visibility when switching to list view
        this.initializeListItems();
        // Apply current sort when switching to list view
        if (this.sortSelect) {
          this.sortPosts(this.sortSelect.value as SortOption);
        }
      }
    }

    sortPosts(sortOption: SortOption) {
      if (!this.postsTableBody) return;

      this.currentSort = sortOption;
      const rows = Array.from(this.postsTableBody.querySelectorAll('.post-list-item'));

      // Get current visible count
      const currentCount = parseInt(
        this.loadMoreBtn?.dataset.currentCount || this.initialCount.toString(),
      );

      rows.sort((a, b) => {
        const aEl = a as HTMLElement;
        const bEl = b as HTMLElement;

        switch (sortOption) {
          case 'date-desc':
            return parseInt(bEl.dataset.postDate || '0') - parseInt(aEl.dataset.postDate || '0');
          case 'date-asc':
            return parseInt(aEl.dataset.postDate || '0') - parseInt(bEl.dataset.postDate || '0');
          case 'title-asc':
            return (aEl.dataset.postTitle || '').localeCompare(bEl.dataset.postTitle || '');
          case 'title-desc':
            return (bEl.dataset.postTitle || '').localeCompare(aEl.dataset.postTitle || '');
          case 'reading-time-desc':
            return (
              parseInt(bEl.dataset.readingTime || '0') - parseInt(aEl.dataset.readingTime || '0')
            );
          case 'reading-time-asc':
            return (
              parseInt(aEl.dataset.readingTime || '0') - parseInt(bEl.dataset.readingTime || '0')
            );
          case 'category-asc':
            return (aEl.dataset.category || '').localeCompare(bEl.dataset.category || '');
          case 'category-desc':
            return (bEl.dataset.category || '').localeCompare(aEl.dataset.category || '');
          default:
            return 0;
        }
      });

      // Re-append sorted rows and reapply visibility based on current count
      rows.forEach((row, index) => {
        const rowEl = row as HTMLElement;
        this.postsTableBody?.appendChild(row);
        // Reapply visibility based on current count
        if (index < currentCount) {
          rowEl.style.display = '';
        } else {
          rowEl.style.display = 'none';
        }
      });
    }

    initInfiniteScroll() {
      if (!this.loadMoreContainer) return;

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && !this.isLoading) {
              this.loadMorePosts().catch(() => {});
            }
          });
        },
        {
          rootMargin: '100px',
        },
      );

      observer.observe(this.loadMoreContainer);
    }

    async loadMorePosts() {
      if (this.isLoading || !this.loadMoreBtn || !this.loadMoreContainer) return;

      this.isLoading = true;
      this.showLoading();

      const currentCount = parseInt(this.loadMoreBtn.dataset.currentCount || '0');
      const loadCount = parseInt(this.loadMoreBtn.dataset.loadCount || '6');
      const totalPosts = parseInt(this.loadMoreBtn.dataset.totalPosts || '0');

      // Simulate loading delay for better UX
      await new Promise((resolve) => setTimeout(resolve, 300));

      // Show the next batch of posts
      if (this.currentView === 'grid') {
        this.showNextPostsGrid(currentCount, loadCount);
      } else {
        this.showNextPostsList(currentCount, loadCount);
      }

      // Update the current count
      const newCount = Math.min(currentCount + loadCount, totalPosts);
      this.loadMoreBtn.dataset.currentCount = newCount.toString();

      // Update progress indicator
      this.updateProgressIndicator(newCount, totalPosts);

      // Hide load more button if all posts are loaded
      if (newCount >= totalPosts) {
        this.loadMoreContainer.style.display = 'none';
      }

      this.hideLoading();
      this.isLoading = false;
    }

    showNextPostsGrid(currentCount: number, loadCount: number) {
      if (!this.postsGrid) return;

      const postItems = this.postsGrid.querySelectorAll('.post-item');
      const endIndex = Math.min(currentCount + loadCount, postItems.length);

      // Show the next batch of posts
      for (let i = currentCount; i < endIndex; i++) {
        const postItem = postItems[i] as HTMLElement;
        if (postItem) {
          postItem.classList.remove('hidden');
          postItem.classList.add('visible', 'fade-in');
        }
      }
    }

    showNextPostsList(currentCount: number, loadCount: number) {
      if (!this.postsTableBody) return;

      const rows = this.postsTableBody.querySelectorAll('.post-list-item');
      const endIndex = Math.min(currentCount + loadCount, rows.length);

      // Show the next batch of posts
      for (let i = currentCount; i < endIndex; i++) {
        const row = rows[i] as HTMLElement;
        if (row) {
          row.classList.remove('hidden');
          row.style.display = '';
        }
      }
    }

    showLoading() {
      if (this.loadingSpinner) {
        this.loadingSpinner.classList.remove('hidden');
      }
      if (this.loadMoreBtn) {
        this.loadMoreBtn.disabled = true;
        this.loadMoreBtn.textContent = 'Loading...';
      }
    }

    hideLoading() {
      if (this.loadingSpinner) {
        this.loadingSpinner.classList.add('hidden');
      }
      if (this.loadMoreBtn) {
        this.loadMoreBtn.disabled = false;
        this.loadMoreBtn.textContent = 'Load More Writings';
      }
    }

    updateProgressIndicator(currentCount: number, totalCount: number) {
      if (this.progressIndicator) {
        const percentage = Math.round((currentCount / totalCount) * 100);
        this.progressIndicator.textContent = `Showing ${currentCount} of ${totalCount} writings (${percentage}% complete)`;
      }
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new LazyPosts();
  });
</script>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .load-more-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Post item visibility */
  .post-item.hidden {
    display: none;
  }

  .post-item.visible {
    display: block;
  }

  /* Fade-in animation for newly shown posts */
  .post-item.fade-in {
    animation: fadeInUp 0.4s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Stagger animation for multiple posts */
  .post-item.fade-in:nth-child(1) {
    animation-delay: 0ms;
  }
  .post-item.fade-in:nth-child(2) {
    animation-delay: 50ms;
  }
  .post-item.fade-in:nth-child(3) {
    animation-delay: 100ms;
  }
  .post-item.fade-in:nth-child(4) {
    animation-delay: 150ms;
  }
  .post-item.fade-in:nth-child(5) {
    animation-delay: 200ms;
  }
  .post-item.fade-in:nth-child(6) {
    animation-delay: 250ms;
  }

  /* List view styles */
  .posts-list-view {
    width: 100%;
    overflow: visible;
  }

  .list-sorting-controls {
    overflow: visible;
    position: relative;
    z-index: 1;
  }

  .list-sorting-controls select {
    position: relative;
    z-index: 1;
  }

  .list-sorting-controls select:focus {
    z-index: 2;
  }

  .list-table-container {
    border: 1px solid rgb(var(--color-border) / 0.2);
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .posts-list-view table {
    width: 100%;
    border-collapse: collapse;
  }

  .posts-list-view thead {
    background: rgb(var(--color-bg-alt));
  }

  .posts-list-view tbody tr {
    transition: background-color 0.2s ease;
  }

  .posts-list-view tbody tr:hover {
    background: rgb(var(--color-bg-alt));
  }

  /* Hide list items initially (they'll be shown by loadMorePosts) */
  .posts-list-view tbody .post-list-item {
    display: table-row;
  }

  /* Responsive list view */
  @media (max-width: 768px) {
    .list-table-container {
      font-size: 0.875rem;
      border-radius: 0.375rem;
    }

    .list-sorting-controls {
      padding: 0.75rem;
      gap: 0.75rem;
    }

    .list-sorting-controls label {
      font-size: 0.8125rem;
    }

    .list-sorting-controls select {
      font-size: 0.8125rem;
      padding: 0.5rem 0.75rem;
    }

    .posts-list-view th,
    .posts-list-view td {
      padding: 0.5rem 0.25rem;
      font-size: 0.8125rem;
    }

    .posts-list-view th:first-child,
    .posts-list-view td:first-child {
      padding-left: 1rem;
    }

    .posts-list-view th:last-child,
    .posts-list-view td:last-child {
      padding-right: 0.5rem;
    }

    /* Hide some columns on mobile */
    .post-category-cell,
    .post-featured-cell {
      display: none;
    }

    .post-list-title {
      font-size: 0.875rem;
      line-height: 1.4;
    }
  }

  @media (max-width: 640px) {
    .list-sorting-controls {
      flex-direction: column;
      align-items: stretch;
    }

    .list-sorting-controls label {
      margin-bottom: 0.25rem;
    }

    .list-sorting-controls select {
      width: 100%;
    }
  }
</style>
