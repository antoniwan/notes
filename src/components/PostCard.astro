---
import type { CollectionEntry } from 'astro:content';
import FormattedDate from './FormattedDate.astro';
import DefaultImage from './DefaultImage.astro';
import { calculateReadingTimeFromMarkdown } from '../utils/readingTime';

interface Props {
  post: CollectionEntry<'blog'>;
  featured?: boolean;
  compact?: boolean;
}

const { post, featured = false, compact = false } = Astro.props;
const { data } = post;

// Calculate reading time from post content
const readingTime = calculateReadingTimeFromMarkdown(post.body || '');
---

<article
  class="interactive-card group relative overflow-hidden rounded-lg"
  class:list={{
    'featured-card': featured,
    'compact-card': compact,
  }}
  role="article"
  data-post-slug={post.id}
>
  <!-- Read indicator -->
  <div class="read-indicator" data-post-slug={post.id}>
    <span class="read-dot"></span>
  </div>

  <!-- Hero Image Container - Enhanced for consistent sizing and coverage -->
  <div class="image-container relative overflow-hidden rounded-t-lg">
    {
      data.heroImage ? (
        <img
          src={data.heroImage}
          alt={data.title}
          class="h-32 w-full object-cover object-center md:h-40"
          loading="lazy"
        />
      ) : (
        <DefaultImage
          alt={data.title}
          className="h-32 w-full object-cover object-center md:h-40"
          loading="lazy"
        />
      )
    }
  </div>

  <!-- Card content -->
  <div class="relative p-3 sm:p-4 md:p-5">
    <div class="space-y-3">
      <!-- Header with metadata -->
      <header class="space-y-2">
        <div class="text-body-muted flex items-center gap-1.5 text-xs leading-relaxed">
          <FormattedDate date={data.pubDate} />
          <span
            class="reading-time-display"
            data-post-slug={post.id}
            data-original-reading-time={readingTime || ''}
          >
            {
              readingTime && (
                <>
                  <span aria-hidden="true">â€¢</span>
                  <span>{readingTime}</span>
                </>
              )
            }
          </span>
          {
            featured && (
              <>
                <span aria-hidden="true">â€¢</span>
                <span
                  class="text-sm font-semibold text-[rgb(var(--color-primary))]"
                  role="img"
                  aria-label="Featured post"
                >
                  ðŸ«€
                </span>
              </>
            )
          }
        </div>

        <h2
          id={`postcard-title-${post.id}`}
          class="postcard-title text-base leading-tight text-[rgb(var(--color-text))] sm:text-lg md:text-xl"
        >
          <a href={`/p/${post.id}/`} class="block" style="font-weight: 700 !important;">
            {data.title}
          </a>
        </h2>
      </header>

      <!-- Description -->
      {
        data.description && (
          <p class="postcard-description text-body-muted mt-2 line-clamp-2 text-sm leading-relaxed sm:text-base md:line-clamp-2">
            {data.description}
          </p>
        )
      }
    </div>
  </div>
</article>

<script>
  // ReadStateService is initialized by ReadStateServiceInit component in BaseLayout
  // Get the singleton instance
  const readStateService = (window as any).ReadStateService?.getInstance();

  // Update indicators for all post cards
  function updateIndicators() {
    if (!readStateService) return; // Exit early if service not available

    document.querySelectorAll('.read-indicator').forEach((indicator) => {
      const postSlug = (indicator as HTMLElement).dataset.postSlug;
      const dot = indicator.querySelector('.read-dot');

      if (postSlug && dot) {
        const isRead = readStateService.isRead(postSlug);
        const readingTimeElement = document.querySelector(
          `.reading-time-display[data-post-slug="${postSlug}"]`,
        );

        if (isRead) {
          dot.classList.add('read');
          indicator.setAttribute('title', 'Read');

          // Replace reading time with "Read" for read posts
          if (readingTimeElement) {
            let timeSpan = readingTimeElement.querySelector('span:last-child');
            if (!timeSpan) {
              const separator = document.createElement('span');
              separator.setAttribute('aria-hidden', 'true');
              separator.textContent = 'â€¢';
              timeSpan = document.createElement('span');
              readingTimeElement.appendChild(separator);
              readingTimeElement.appendChild(timeSpan);
            }
            timeSpan.textContent = 'Read';
            (readingTimeElement as HTMLElement).style.display = 'inline';
          }
        } else {
          dot.classList.remove('read');
          indicator.setAttribute('title', 'Unread');

          // Restore original reading time for unread posts
          if (readingTimeElement) {
            const originalReadingTime = readingTimeElement.getAttribute(
              'data-original-reading-time',
            );
            if (originalReadingTime) {
              let timeSpan = readingTimeElement.querySelector('span:last-child');
              if (!timeSpan) {
                const separator = document.createElement('span');
                separator.setAttribute('aria-hidden', 'true');
                separator.textContent = 'â€¢';
                timeSpan = document.createElement('span');
                readingTimeElement.appendChild(separator);
                readingTimeElement.appendChild(timeSpan);
              }
              timeSpan.textContent = originalReadingTime;
            } else {
              (readingTimeElement as HTMLElement).style.display = 'none';
            }
          }
        }
      }
    });
  }

  // Subscribe to all read state changes (only if service is available)
  let unsubscribe: (() => void) | null = null;
  if (readStateService) {
    unsubscribe = readStateService.subscribeToAll(() => {
      updateIndicators();
    });

    // Initial update
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateIndicators);
    } else {
      updateIndicators();
    }
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (unsubscribe) {
      unsubscribe();
    }
  });
</script>

<style>
  /* Read indicator styling */
  .read-indicator {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    z-index: 10;
    pointer-events: none;
  }

  .read-dot {
    display: block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgb(var(--color-border));
    border: 2px solid rgb(var(--color-bg));
    transition: all 0.2s ease;
  }

  .read-dot.read {
    background: rgb(34, 197, 94);
    border-color: rgb(34, 197, 94);
    box-shadow: 0 0 0 2px rgb(34, 197, 94, 0.2);
  }

  /* Simplified card styling - isolated from parent context */
  :global(.prose) article.interactive-card,
  article.interactive-card {
    transition:
      box-shadow 0.2s ease,
      border-color 0.2s ease;
    border: 1px solid rgb(var(--color-border) / 0.2) !important;
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1) !important;
    /* Ensure consistent sizing regardless of parent */
    width: 100% !important;
    display: block !important;
    /* Reset any prose-inherited styles */
    margin: 0 !important;
    max-width: 100% !important;
    /* Override prose * styles */
    box-sizing: border-box !important;
    /* Ensure consistent background */
    background: rgb(var(--color-bg)) !important;
  }

  /* Isolate card content from prose typography - override prose styles and global h2 styles */
  :global(.prose) article.interactive-card h2[id^='postcard-title-'],
  :global(.prose) article.interactive-card .postcard-title,
  article.interactive-card h2[id^='postcard-title-'],
  article.interactive-card h2.postcard-title,
  article.interactive-card .postcard-title {
    margin: 0 !important;
    margin-top: 0 !important;
    margin-bottom: 0 !important;
    font-size: 1rem !important;
    line-height: 1.3 !important;
    font-weight: 700 !important; /* Bold - override prose h2 and global h2 styles */
    letter-spacing: normal !important;
  }

  /* Responsive title sizes - override prose h2 styles */
  @media (min-width: 640px) {
    :global(.prose) article.interactive-card h2[id^='postcard-title-'],
    :global(.prose) article.interactive-card .postcard-title,
    article.interactive-card h2[id^='postcard-title-'],
    article.interactive-card h2.postcard-title,
    article.interactive-card .postcard-title {
      font-size: 1.125rem !important;
      font-weight: 700 !important;
    }
  }

  @media (min-width: 768px) {
    :global(.prose) article.interactive-card h2[id^='postcard-title-'],
    :global(.prose) article.interactive-card .postcard-title,
    article.interactive-card h2[id^='postcard-title-'],
    article.interactive-card h2.postcard-title,
    article.interactive-card .postcard-title {
      font-size: 1.25rem !important;
      font-weight: 700 !important;
    }
  }

  :global(.prose) article.interactive-card .postcard-description,
  article.interactive-card .postcard-description {
    margin: 0 !important;
    margin-top: 0.5rem !important;
    margin-bottom: 0 !important;
    font-size: 0.875rem !important;
    line-height: 1.6 !important;
  }

  /* Responsive description sizes */
  @media (min-width: 640px) {
    :global(.prose) article.interactive-card .postcard-description,
    article.interactive-card .postcard-description {
      font-size: 1rem !important;
    }
  }

  :global(.prose) article.interactive-card h2 a,
  article.interactive-card h2 a {
    text-decoration: none !important;
    color: inherit !important;
  }

  /* Override prose * max-width for card content */
  :global(.prose) article.interactive-card *,
  article.interactive-card * {
    max-width: 100% !important;
  }

  /* Enhanced image container styling for consistent sizing and coverage */
  article.interactive-card .image-container {
    position: relative;
    width: 100%;
    height: 8rem; /* 128px - compact height for mobile */
    background: rgb(var(--color-bg-alt));
    overflow: hidden;
  }

  /* Ensure images cover the entire container - isolate from prose img styles */
  :global(.prose) article.interactive-card .image-container img,
  article.interactive-card .image-container img {
    /* Force override all prose img !important styles */
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    object-position: center !important;
    display: block !important;
    border: none !important;
    outline: none !important;
    margin: 0 !important;
    max-width: 100% !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    cursor: default !important;
    overflow: visible !important;
  }

  /* Responsive image heights */
  @media (min-width: 768px) {
    article.interactive-card .image-container {
      height: 10rem; /* 160px - compact height for desktop */
    }
  }

  /* Simplified featured card styling */
  .featured-card {
    border: 2px solid rgb(var(--color-primary) / 0.3);
    box-shadow: 0 4px 12px -2px rgb(var(--color-primary) / 0.15);
  }

  /* Compact card styling */
  .compact-card {
    @apply p-3 sm:p-4 md:p-6;
  }

  .compact-card .space-y-3 > * + * {
    margin-top: 0.75rem;
  }

  .compact-card .space-y-4 > * + * {
    margin-top: 1rem;
  }

  .compact-card .space-y-5 > * + * {
    margin-top: 1.25rem;
  }

  /* Simplified hover effects */
  .group:hover {
    box-shadow: 0 4px 12px -2px rgb(0 0 0 / 0.15);
    border-color: rgb(var(--color-primary) / 0.3);
  }

  /* Enhanced focus states */
  .group:focus-within {
    outline: 2px solid rgb(var(--color-primary));
    outline-offset: 2px;
    border-radius: 0.75rem;
  }

  /* Improved line heights for better readability */
  .text-lg {
    line-height: 1.4;
  }

  .text-xl {
    line-height: 1.4;
  }

  .text-2xl {
    line-height: 1.3;
  }

  .text-3xl {
    line-height: 1.2;
  }

  /* Enhanced spacing between elements */
  .space-y-3 > * + * {
    margin-top: 0.75rem;
  }

  .space-y-4 > * + * {
    margin-top: 1rem;
  }

  .space-y-5 > * + * {
    margin-top: 1.25rem;
  }

  /* Ensure postcard grids have consistent spacing regardless of parent context */
  :global(.postcards-grid) {
    /* Reset any prose or container inherited margins */
    margin-top: 0;
    margin-bottom: 0;
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    article.interactive-card {
      transition: none !important;
    }

    .group:hover {
      transform: none;
    }

    .read-dot {
      transition: none !important;
    }
  }
</style>
