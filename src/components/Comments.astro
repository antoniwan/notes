---
import { commentsConfig } from '../config/comments';
import { generateCanonicalUrl } from '../utils/seo';

const pageUrl = generateCanonicalUrl(Astro.url.pathname);
const { host, siteId } = commentsConfig;
---

<div class="comments-section mt-12 pt-8">
  <h2 class="mb-6 text-2xl font-bold text-[rgb(var(--color-text))]">ðŸ’¬ Join the Conversation</h2>
  <p class="text-body-muted mb-8">
    Share your thoughts, ask questions, or simply let me know what resonated with you. I read and
    respond to every comment personally. Sign in with your favorite social account to participate.
  </p>

  <div
    id="comments-container"
    class="remark42-container overflow-hidden rounded-lg bg-[rgb(var(--color-bg))]"
    data-host={host}
    data-site-id={siteId}
    data-page-url={pageUrl}
  >
    <div id="remark42"></div>
    <noscript>
      <p class="p-8 text-center text-[rgb(var(--color-text-muted))]">
        Please enable JavaScript to view comments.
      </p>
    </noscript>
  </div>
</div>

<script>
  // Store the current Remark42 instance so we can destroy it on SPA navigation
  let remark42Instance: { destroy: () => void } | null = null;

  // Store the lazy-load observer so we can disconnect it on navigation (avoids leak when user never scrolls to comments)
  let lazyLoadObserver: IntersectionObserver | null = null;

  function createRemark42Instance(
    node: HTMLElement,
    host: string,
    siteId: string,
    pageUrl: string,
  ) {
    const isDark = document.documentElement.classList.contains('dark');
    const config = {
      host,
      site_id: siteId,
      url: pageUrl,
      theme: isDark ? 'dark' : 'light',
      components: ['embed'],
      no_footer: false,
    };
    return window.REMARK42!.createInstance({ node, ...config });
  }

  function initRemark42() {
    // Disconnect any previous lazy-load observer to avoid leaking one per navigation (view transitions)
    if (lazyLoadObserver) {
      lazyLoadObserver.disconnect();
      lazyLoadObserver = null;
    }

    const container = document.getElementById('comments-container');
    if (!container) return;

    const host = container.dataset.host;
    const siteId = container.dataset.siteId;
    const pageUrl = container.dataset.pageUrl ?? window.location.href;

    if (!host || !siteId) return;

    const node = document.getElementById('remark42');
    if (!node) return;

    // SPA: destroy previous instance so comments match the current page (Remark42 SPA docs)
    if (window.REMARK42 && remark42Instance) {
      try {
        remark42Instance.destroy();
      } catch {
        // Instance may already be torn down
      }
      remark42Instance = null;
    }

    if (window.REMARK42) {
      remark42Instance = createRemark42Instance(node, host, siteId, pageUrl);
      return;
    }

    // When REMARK42 is ready (now or later), create the instance. Handles race where
    // embed.js sets REMARK42 and dispatches REMARK42::ready before our onload/listener runs.
    function whenRemark42Ready(cb: () => void) {
      if (window.REMARK42) {
        cb();
        return;
      }
      window.addEventListener(
        'REMARK42::ready',
        cb,
        { once: true },
      );
    }

    // Script not loaded yet: load it, then create instance when REMARK42 is ready
    function loadScript() {
      const scriptEl = document.querySelector(`script[src="${host}/web/embed.js"]`);
      if (scriptEl) {
        whenRemark42Ready(() => {
          const el = document.getElementById('remark42');
          if (!el || !host || !siteId) return;
          if (remark42Instance) {
            try {
              remark42Instance.destroy();
            } catch {}
            remark42Instance = null;
          }
          remark42Instance = createRemark42Instance(el, host, siteId, pageUrl);
        });
        return;
      }

      // Remark42 embed.js reads window.remark_config on load; set it so they don't throw (reading 'host' of undefined)
      window.remark_config = {
        host,
        site_id: siteId,
        url: pageUrl,
      };

      const script = document.createElement('script');
      script.src = `${host}/web/embed.js`;
      script.async = true;
      script.defer = true;
      script.onload = () => {
        whenRemark42Ready(() => {
          const el = document.getElementById('remark42');
          if (!el || !host || !siteId) return;
          remark42Instance = createRemark42Instance(el, host, siteId, pageUrl);
        });
      };
      document.head.appendChild(script);
    }

    // Lazy load: only load when comments section is near the viewport
    if ('IntersectionObserver' in window) {
      lazyLoadObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && lazyLoadObserver) {
              loadScript();
              lazyLoadObserver.disconnect();
              lazyLoadObserver = null;
            }
          });
        },
        { rootMargin: '200px' },
      );
      lazyLoadObserver.observe(container);
    } else {
      loadScript();
    }
  }

  // Theme sync: update Remark42 when theme changes
  function updateRemark42Theme() {
    const isDark = document.documentElement.classList.contains('dark');
    const theme = isDark ? 'dark' : 'light';

    if (window.REMARK42) {
      try {
        window.REMARK42.changeTheme(theme);
      } catch {
        // Remark42 not ready yet
      }
    }
  }

  // Register theme and navigation listeners only once to avoid leaks when this script
  // re-runs on each Astro view transition (new listeners would stack and fire repeatedly).
  const win = window as Window & { __commentsListenersInstalled?: boolean };
  if (!win.__commentsListenersInstalled) {
    win.__commentsListenersInstalled = true;

    window.addEventListener('themechange', () => {
      setTimeout(updateRemark42Theme, 100);
    });

    const themeObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
          setTimeout(updateRemark42Theme, 100);
        }
      });
    });
    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class'],
    });

    document.addEventListener('astro:page-load', initRemark42);
  }

  // Also initialize on regular page load for non-view-transition navigation
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRemark42);
  } else {
    initRemark42();
  }
</script>

<style>
  /* Remark42 container styling */
  :global(#remark42) {
    min-height: 100px;
  }

  /* Ensure Remark42 respects dark mode */
  :global(.dark #remark42) {
    color-scheme: dark;
  }
</style>
