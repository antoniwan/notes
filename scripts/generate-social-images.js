import sharp from 'sharp';
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const publicDir = path.join(__dirname, '../public');
const socialRootDir = path.join(publicDir, 'social');

async function ensureDir(dir) {
  await fs.mkdir(dir, { recursive: true });
}

function toWebPath(fsPath) {
  const relative = path.relative(publicDir, fsPath);
  return '/' + relative.split(path.sep).join('/');
}

async function getAvifFiles(rootDir) {
  const results = [];

  async function walk(dir) {
    let entries;
    try {
      entries = await fs.readdir(dir, { withFileTypes: true });
    } catch {
      return;
    }

    for (const entry of entries) {
      const fullPath = path.join(dir, entry.name);

      // Skip the social output folder so we don't re-process generated files
      if (entry.isDirectory()) {
        if (path.relative(publicDir, fullPath).split(path.sep)[0] === 'social') {
          continue;
        }
        await walk(fullPath);
      } else if (entry.isFile()) {
        if (entry.name.toLowerCase().endsWith('.avif')) {
          results.push(fullPath);
        }
      }
    }
  }

  await walk(rootDir);
  return results;
}

async function findExistingSocialVariant(relativeDir, baseName) {
  const targetDir = path.join(socialRootDir, relativeDir);
  const jpegPath = path.join(targetDir, `${baseName}-social.jpg`);
  const pngPath = path.join(targetDir, `${baseName}-social.png`);

  try {
    await fs.stat(jpegPath);
    return jpegPath;
  } catch {}

  try {
    await fs.stat(pngPath);
    return pngPath;
  } catch {}

  return null;
}

async function generateSocialForFile(filePath) {
  const relative = path.relative(publicDir, filePath);
  const relDir = path.dirname(relative) === '.' ? '' : path.dirname(relative);
  const base = path.basename(filePath, path.extname(filePath));

  // If we already have a generated social image, reuse it (cache)
  const existing = await findExistingSocialVariant(relDir, base);
  if (existing) {
    return {
      original: '/' + relative.split(path.sep).join('/'),
      social: toWebPath(existing),
    };
  }

  const sourceBuffer = await fs.readFile(filePath);

  const targetDir = path.join(socialRootDir, relDir);
  await ensureDir(targetDir);

  const jpegPath = path.join(targetDir, `${base}-social.jpg`);
  const pngPath = path.join(targetDir, `${base}-social.png`);

  // Encode as JPEG and PNG, then pick the smaller file
  await sharp(sourceBuffer).jpeg({ quality: 82, chromaSubsampling: '4:4:4' }).toFile(jpegPath);
  await sharp(sourceBuffer).png({ compressionLevel: 9, adaptiveFiltering: true }).toFile(pngPath);

  const [jpegStat, pngStat] = await Promise.all([fs.stat(jpegPath), fs.stat(pngPath)]);

  let chosenPath = jpegPath;
  let discardPath = pngPath;
  if (pngStat.size < jpegStat.size) {
    chosenPath = pngPath;
    discardPath = jpegPath;
  }

  try {
    await fs.unlink(discardPath);
  } catch {
    // If deletion fails, it's non-fatal; we just keep the extra file.
  }

  return {
    original: '/' + relative.split(path.sep).join('/'),
    social: toWebPath(chosenPath),
  };
}

async function writeManifest(mappings) {
  const manifestPath = path.join(__dirname, '../src/data/socialImageManifest.ts');

  const lines = [
    '// Auto-generated by scripts/generate-social-images.js. DO NOT EDIT BY HAND.',
    'export const SOCIAL_IMAGE_MANIFEST: Record<string, string> = {',
    ...mappings.map(({ original, social }) => `  "${original}": "${social}",`),
    '};',
    '',
  ];

  await fs.writeFile(manifestPath, lines.join('\n'), 'utf8');
}

async function main() {
  console.log('üîç Scanning for AVIF images under /public ...');
  await ensureDir(publicDir);
  await ensureDir(socialRootDir);

  const avifFiles = await getAvifFiles(publicDir);

  if (avifFiles.length === 0) {
    console.log('No .avif files found under /public; nothing to generate.');
    await writeManifest([]);
    return;
  }

  const mappings = [];

  for (const file of avifFiles) {
    console.log(`üì∏ Processing ${toWebPath(file)} ...`);
    const mapping = await generateSocialForFile(file);
    mappings.push(mapping);
  }

  await writeManifest(mappings);
  console.log(`‚úÖ Generated social images for ${mappings.length} source file(s).`);
}

main().catch((err) => {
  console.error('‚ùå Error generating social images:', err);
  process.exit(1);
});
